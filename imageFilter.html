<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="./static/js/fabric.js"></script>
    <script src="./static/js/Vibrant.min.js"></script>
</head>
<body>
<div id="bd-wrapper" ng-controller="CanvasControls">
    <h2>Image Filters</h2>

    <style>
        .controls { display: inline-block; background: #fafafa; margin-left: 10px; padding: 15px; border-left: 1px dotted #aaa; }
        .canvas-container { display: inline-block; vertical-align: top; }
        /*input[disabled] { opacity: 0.5; }*/
        #bd-wrapper { min-width: 1600px; }
    </style>

    <div class="canvas-container" style="width: 600px; height: 600px; position: relative; -webkit-user-select: none;">
        <canvas id="c" width="600" height="600" class="lower-canvas" style="position: absolute; width: 600px; height: 600px; left: 0px; top: 0px; -webkit-user-select: none;"></canvas>
        <canvas class="upper-canvas " width="600" height="600" style="position: absolute; width: 600px; height: 600px; left: 0px; top: 0px; -webkit-user-select: none; cursor: move;"></canvas></div>
    <div class="controls">
        <h3>Filters:</h3>
        <p>
            <input type="checkbox" id="remove-white">去除白色
        </p>
        <p>
            <input type="checkbox" id="color-matrix">颜色矩阵
        </p>
    </div>


</div>
</body>
</html>

<script id="main">(function() {
    var $ = function(id){return document.getElementById(id)};

    function applyFilter(index, filter) {
        var obj = canvas.getActiveObject();
        obj.filters[index] = filter;
        obj.applyFilters(canvas.renderAll.bind(canvas));
    }

    function applyFilterValue(index, prop, value) {
        var obj = canvas.getActiveObject();
        if (obj.filters[index]) {
            obj.filters[index][prop] = value;
            obj.applyFilters(canvas.renderAll.bind(canvas));
        }
    }

    fabric.Object.prototype.padding = 5;
    fabric.Object.prototype.transparentCorners = false;

    var canvas = this.__canvas = new fabric.Canvas('c'),
            f = fabric.Image.filters;

    fabric.Image.fromURL('./static/img/bg.png', function(img) {
        canvas.backgroundImage = img;
        canvas.backgroundImage.width = 600;
        canvas.backgroundImage.height = 600;
    });


    canvas.on({
        'object:selected': function() {
            /*fabric.util.toArray(document.getElementsByTagName('input'))
             .forEach(function(el){ el.disabled = false; })*/

            var filters = ['grayscale', 'invert', 'remove-white', 'sepia', 'sepia2',
                'brightness', 'contrast', 'saturate', 'noise', 'gradient-transparency', 'pixelate',
                'blur', 'sharpen', 'emboss', 'tint', 'multiply', 'blend'];

            for (var i = 0; i < filters.length; i++) {
                if ($(filters[i])) {
                    $(filters[i]).checked = !!canvas.getActiveObject().filters[i];
                }
            }
        },
        'selection:cleared': function() {
            /*fabric.util.toArray(document.getElementsByTagName('input'))
             .forEach(function(el){ el.disabled = true; })*/
        }
    });

    fabric.Image.fromURL('./static/img/Peace.jpg', function(img) {
        var oImg = img.set({ left: 50, top: 100, angle: -15 }).scale(0.9);
        canvas.add(oImg).renderAll();
        canvas.setActiveObject(oImg);
    });
    var indexF;
    $('remove-white').addEventListener('click',removeWhite);
    function removeWhite() {
        applyFilter(2, this.checked && new f.RemoveWhite({
            threshold: 40,
            distance: 140
        }));
    }
    $('color-matrix').addEventListener('click',colorMatrix);
    function colorMatrix() {
        debugger;
        var object = canvas.getActiveObject();

        var filter = new fabric.Image.filters.ColorMatrix({
            matrix: [
                1.1285582396593525, -0.3967382283601348, -0.03992559172921793, 0, 63.72958762196502,
                -0.16404339962244616, 1.0835251566291304, -0.05498805115633132, 0, 24.732407896706203,
                -0.16786010706155763, -0.5603416277695248, 1.6014850761964943, 0, 35.62982807460946,
                0, 0, 0, 1, 0
            ]
        });
        object.filters.push(filter);
        object.applyFilters(canvas.renderAll.bind(canvas));
    }
})();
</script>